name: Build and Release

on:
    release:
        types: [created]
    workflow_dispatch:

jobs:
    build-image:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - uses: actions/checkout@v4

            - uses: cachix/install-nix-action@v25
              with:
                  extra_nix_config: |
                      experimental-features = nix-command flakes
                      max-jobs = auto
                      cores = 0

            - name: Build image
              run: nix build .#default -L

            - name: Prepare release
              run: |
                  mkdir -p dist
                  cp result/nixos.qcow2 dist/kyun-nixos-${{ github.ref_name }}.qcow2
                  sha256sum dist/kyun-nixos-${{ github.ref_name }}.qcow2 > dist/kyun-nixos-${{ github.ref_name }}.qcow2.sha256

            - name: Upload to release
              if: github.event_name == 'release'
              uses: softprops/action-gh-release@v1
              with:
                  files: dist/*
                  body: |
                      ## NixOS Cloud Image for Kyun.host

                      Download, verify checksum, and upload to kyun.host dashboard.
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload artifact
              if: github.event_name == 'workflow_dispatch'
              uses: actions/upload-artifact@v4
              with:
                  name: kyun-nixos-image
                  path: dist/*
                  retention-days: 7
