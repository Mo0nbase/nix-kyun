name: Build and Release

on:
    release:
        types: [created]
    workflow_dispatch:

jobs:
    build-image:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - uses: actions/checkout@v4

            - uses: DeterminateSystems/nix-installer-action@main

            - name: Build image
              run: nix build .#default -L

            - name: Prepare release
              run: |
                  mkdir -p dist
                  cp result/nixos.qcow2 dist/nixos-danbo-${{ github.ref_name }}.qcow2
                  sha256sum dist/nixos-danbo-${{ github.ref_name }}.qcow2 > dist/nixos-danbo-${{ github.ref_name }}.qcow2.sha256

            - name: Upload to release
              if: github.event_name == 'release'
              uses: softprops/action-gh-release@v1
              with:
                  files: dist/*
                  body: |
                      ## Danbo - NixOS Cloud Image for Kyun.host

                      Download, verify checksum, and upload to kyun.host dashboard.
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload artifact
              if: github.event_name == 'workflow_dispatch'
              uses: actions/upload-artifact@v4
              with:
                  name: nixos-danbo-image
                  path: dist/*
                  retention-days: 7
