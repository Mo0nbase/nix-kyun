name: Build and Release

on:
    release:
        types: [created]
    workflow_dispatch:
        inputs:
            tag:
                description: "Tag to release (optional)"
                required: false

jobs:
    build-image:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install Nix
              uses: cachix/install-nix-action@v25
              with:
                  extra_nix_config: |
                      experimental-features = nix-command flakes
                      # Ensure reproducible builds
                      sandbox = true
                      max-jobs = auto

            - name: Build and prepare image
              run: |
                  # Clean build without any cached artifacts
                  nix build .#default -L --option pure-eval true

                  # Copy image out of read-only Nix store and create checksum
                  mkdir -p dist
                  cp result/nixos.qcow2 dist/kyun-nixos-${{ github.ref_name }}.qcow2
                  cd dist
                  sha256sum kyun-nixos-${{ github.ref_name }}.qcow2 > kyun-nixos-${{ github.ref_name }}.qcow2.sha256

            - name: Upload image to release
              uses: softprops/action-gh-release@v1
              if: github.event_name == 'release'
              with:
                  files: |
                      dist/kyun-nixos-${{ github.ref_name }}.qcow2
                      dist/kyun-nixos-${{ github.ref_name }}.qcow2.sha256
                  body: |
                      ## NixOS Cloud Image for Kyun.host

                      ### Installation

                      1. Download `kyun-nixos-${{ github.ref_name }}.qcow2`
                      2. Verify checksum: `sha256sum -c kyun-nixos-${{ github.ref_name }}.qcow2.sha256`
                      3. Upload to kyun.host dashboard

                      ### Features
                      - NixOS 24.11
                      - Cloud-init support (NoCloud datasource via /dev/sr1)
                      - Static networking (IPv4/IPv6)
                      - QEMU guest agent
                      - ext4 filesystem
                      - BIOS boot (GPT/hybrid partitioning)
                      - Serial console enabled (ttyS0)

                      See [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) for documentation.
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload artifact (workflow dispatch)
              if: github.event_name == 'workflow_dispatch'
              uses: actions/upload-artifact@v4
              with:
                  name: kyun-nixos-image
                  path: |
                      dist/kyun-nixos-${{ github.ref_name }}.qcow2
                      dist/kyun-nixos-${{ github.ref_name }}.qcow2.sha256
                  retention-days: 30
